generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Candidat {
  id               Int                @id @default(autoincrement())
  nom              String
  prenom           String
  email            String             @unique
  telephone        String?
  adresse          String?
  date_naissance   DateTime?
  filiere_id       Int
  niveau_etude      NiveauEtude
  note_bac          Float?
  note_diplome      Float?
  type_diplome      String?
  statut           StatutCandidature  @default(EN_ATTENTE)
  date_candidature DateTime           @default(now())
  commentaire_admin String?
  user_id          Int? 

  filiere Filiere @relation(fields: [filiere_id], references: [id])
  user    User?   @relation("UserCandidats", fields: [user_id], references: [id])
}

enum StatutCandidature {
  EN_ATTENTE
  ACCEPTEE
  REFUSEE
}
enum NiveauEtude {
  BAC
  BAC_PLUS_1
  BAC_PLUS_2
  BAC_PLUS_3
}


model User {
  id             Int              @id @default(autoincrement())
  nom            String
  email          String           @unique
  mot_de_passe   String
  role_id        Int
  is_verified    Boolean          @default(false)
  is_active      Boolean          @default(true)
  last_login     DateTime?
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  is_two_factor_enabled Boolean          @default(false)
  two_factor_secret     String?
  candidats      Candidat[]       @relation("UserCandidats")
  absences       Absence[]
  actualites     Actualite[]
  cours          Cours[]          @relation("EnseignantCours")
  groupes        EtudiantGroupe[]
  modules        Module[]         @relation("EnseignantModules")
  notes          Note[]
  notifications  Notification[]
  passwordResets PasswordReset[]
  refreshTokens  RefreshToken[]
  settings       Settings?
  ressources     Ressource[]      @relation("EnseignantRessources")
  role           Role             @relation(fields: [role_id], references: [id])
}

model Role {
  id              Int              @id @default(autoincrement())
  nom             String
  description     String?
  rolePermissions RolePermission[]
  users           User[]
}

model Permission {
  id              Int              @id @default(autoincrement())
  nom             String
  code            String
  description     String?
  rolePermissions RolePermission[]
}

model RolePermission {
  id            Int        @id @default(autoincrement())
  role_id       Int
  permission_id Int
  permission    Permission @relation(fields: [permission_id], references: [id])
  role          Role       @relation(fields: [role_id], references: [id])
}

model RefreshToken {
  id         Int      @id @default(autoincrement())
  user_id    Int
  token      String
  expires_at DateTime
  revoked    Boolean  @default(false)
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id])
}

model PasswordReset {
  id         Int      @id @default(autoincrement())
  user_id    Int
  code       String
  type       String
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id])
}

model Niveau {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  label     String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  filiere   Filiere?  @relation(fields: [filiereId], references: [id])
  filiereId Int?
  groupes   Groupe[]
}

model Filiere {
  id          Int      @id @default(autoincrement())
  nom         String
  code        String
  description String?
  niveaux     Niveau[]
  groupes     Groupe[]
  modules     Module[]
  candidats   Candidat[]  
  ressources  Ressource[]
}

model Groupe {
  id         Int              @id @default(autoincrement())
  nom        String
  annee      String
  filiere_id Int
  niveauId   Int?

  cours      Cours[]
  etudiants  EtudiantGroupe[]
  filiere    Filiere          @relation(fields: [filiere_id], references: [id])
  niveau    Niveau?          @relation(fields: [niveauId], references: [id])
}

model EtudiantGroupe {
  id          Int    @id @default(autoincrement())
  etudiant_id Int
  groupe_id   Int
  etudiant    User   @relation(fields: [etudiant_id], references: [id])
  groupe      Groupe @relation(fields: [groupe_id], references: [id])
}

model Module {
  id            Int      @id @default(autoincrement())
  nom           String
  code          String
  coefficient   Float
  filiere_id    Int
  enseignant_id Int
  cours         Cours[]
  examens       Examen[]
  ressources    Ressource[]
  
  enseignant    User     @relation("EnseignantModules", fields: [enseignant_id], references: [id])
  filiere       Filiere  @relation(fields: [filiere_id], references: [id])
}

model Ressource {
  id            Int       @id @default(autoincrement())
  titre         String
  description   String?
  fichier_url   String
  type          String
  date_upload   DateTime  @default(now())

  module_id     Int
  enseignant_id Int
  filiere_id    Int

  module        Module    @relation(fields: [module_id], references: [id])
  enseignant    User      @relation("EnseignantRessources", fields: [enseignant_id], references: [id])
  filiere       Filiere  @relation(fields: [filiere_id], references: [id])
}

model Salle {
  id         Int      @id @default(autoincrement())
  nom        String
  capacite   Int
  type       String
  disponible Boolean  @default(true)
  cours      Cours[]
  examens    Examen[]
}

model Cours {
  id            Int        @id @default(autoincrement())
  module_id     Int
  enseignant_id Int
  salle_id      Int
  groupe_id     Int
  titre         String
  date_cours    DateTime
  heure_debut   DateTime
  heure_fin     DateTime
  absences      Absence[]
  enseignant    User       @relation("EnseignantCours", fields: [enseignant_id], references: [id])
  groupe        Groupe     @relation(fields: [groupe_id], references: [id])
  module        Module     @relation(fields: [module_id], references: [id])
  salle         Salle      @relation(fields: [salle_id], references: [id])
  planning      Planning[]
}

model Examen {
  id          Int      @id @default(autoincrement())
  module_id   Int
  salle_id    Int
  date_examen DateTime
  type        String
  coefficient Float
  module      Module   @relation(fields: [module_id], references: [id])
  salle       Salle    @relation(fields: [salle_id], references: [id])
  notes       Note[]
}

model Note {
  id          Int     @id @default(autoincrement())
  examen_id   Int
  etudiant_id Int
  note        Float
  remarque    String?
  etudiant    User    @relation(fields: [etudiant_id], references: [id])
  examen      Examen  @relation(fields: [examen_id], references: [id])
}

model Absence {
  id          Int      @id @default(autoincrement())
  cours_id    Int
  etudiant_id Int
  date        DateTime
  motif       String?
  justifiee   Boolean  @default(false)
  cours       Cours    @relation(fields: [cours_id], references: [id])
  etudiant    User     @relation(fields: [etudiant_id], references: [id])
}

model Planning {
  id          Int      @id @default(autoincrement())
  cours_id    Int
  jour        String
  heure_debut DateTime
  heure_fin   DateTime
  cours       Cours    @relation(fields: [cours_id], references: [id])
}

model Actualite {
  id        Int           @id @default(autoincrement())
  titre     String
  contenu   String
  image_url String?
  type      TypeActualite
  date_pub  DateTime      @default(now())
  auteur_id Int
  auteur    User          @relation(fields: [auteur_id], references: [id])
}

model Notification {
  id         Int      @id @default(autoincrement())
  user_id    Int
  titre      String
  message    String
  type       String
  statut     String   @default("non_lu")
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id])
}

model Settings {
  id                     Int      @id @default(autoincrement())
  user_id                Int      @unique
  langue                 String   @default("fr")
  theme                  String   @default("clair")
  notifications_activees Boolean  @default(true)
  format_date            String   @default("dd/MM/yyyy")
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt
  user                   User     @relation(fields: [user_id], references: [id])
}

enum TypeActualite {
  EVENEMENT
  ANNONCE
  INFO
}
